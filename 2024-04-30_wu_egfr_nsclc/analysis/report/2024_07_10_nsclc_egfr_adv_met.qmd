---
title: "J&J Innovative Medicine Osimertinib Studies"
subtitle: "Reqested by Tony Wu"
author: "Alex Paynter"
date: "Last updated `r Sys.Date()`"
output:
  quarto::quarto_html:
editor_options:
  quarto:
    chunk_output_type: console
  chunk_output_type: console
format:
  html:
    embed-resources: true
    toc: true
    theme: sandstone 
execute:
  echo: false
  include: false
  warning: false
  message: false
  fig.width: 7
  fig.height: 5
---

```{r}

library(purrr); library(fs); library(here)
purrr::walk(.x = fs::dir_ls(here('R')), .f = source)
```


## Introduction

This report assesses the feasibility of using GENIE participants for several studies concerning EGFR NSCLC patients.  To do this, we will look at the NSCLC v3.1 BPC cohort (n = 3549), which detailed information we can assess inclusion criteria with.  We use the BPC data to estimate the maximum number of matching cases which could be curated and the rate of accrual we expect in main GENIE.

```{r}
dft_flow_all <- readr::read_rds(
  here('data', 'table_method_jj_all.rds')
)

cohort_process_help <- function(
    coh, 
    # These numbers come from another project.  Simple linear regression slopes to get the rates from version 11 to 16.
    n_main_genie_nsclc = 26857,
    n_main_genie_nsclc_egfr_mut = 3651,
    rate_main_genie_nsclc = 3762,
    rate_main_genie_nsclc_egfr_mut = 517
) {
  coh %<>%
    mutate(
      n = purrr::map_dbl(
        .x = dat,
        .f = nrow
      )
    )
  
  coh_nsclc_egfr <- coh %>%
    filter(str_detect(message, "EGFR L858R")) %>%
    pull(n)
  
  coh %<>%
    mutate(.prop = n / coh_nsclc_egfr)
  
  coh %<>%
    mutate(
      # retro = main genie retrospective, a count.
      retrospective = case_when(
        str_detect(message, "People with NSCLC") ~ n_main_genie_nsclc,
        str_detect(message, "EGFR L858R") ~ n_main_genie_nsclc_egfr_mut,
        T ~ n_main_genie_nsclc_egfr_mut * .prop
      ),
      prospective = case_when(
       str_detect(message, "People with NSCLC") ~ rate_main_genie_nsclc,
        str_detect(message, "EGFR L858R") ~ rate_main_genie_nsclc_egfr_mut,
      T ~ rate_main_genie_nsclc_egfr_mut * .prop
      )
    )
  
  coh %<>%
    # just for simplicity:
    mutate(
      across(
        .cols = c(n, retrospective, prospective),
        .fns = round
      )
    ) %>%
    select(
      `Step (cumulative)` = message,
      `BPC/curated (n)` = n,
      `Retrospective (n)` = retrospective,
      `Prospective (n/yr.)` = prospective
    )
  return(coh)
}

flow_process_wrap <- function(dat) {
  dat %>%
    cohort_process_help(.) %>%
    flextable(.) %>%
    color(color = "gray70", part = "body") %>%
    color(i = 1:2, color = "black", part = "body") %>%
    color(j = 1:2, color = "black", part = "body") %>%
    # bold(part = "body", i = 1, j = 3) %>%
    # italic(part = "body", i = 1, j = 3) %>%
    autofit(.)
}

dfp_flow_all <- dft_flow_all %>% flow_process_wrap

```


## Filtering

Tables below show how many people are left in the GENIE cohort after each filtering step.  We repeat this exercise three times to accomodate additional study criteria. 

Three numbers are stated in each row:

- **BPC/curated** The number of people with full clinical annotation that are available to access today (for BPC consortium members).
- **Retrospective** The maximum number of cases available for curation which we would expect to meet study criteria.  These come from main GENIE where we have limited clinical annotation today.  Curation could be done selectively of course.
- **Prospective** The number of new cases meeting criteria we would expect to enter the main GENIE cohort each year. 

The study criteria are reordered slightly to put the things we can explicitly evaluate first.  The black numbers represent explicit counts using already-collected data.  The gray numbers are projected estimates from the last black number in each column (see example below).

## COCOON and COPERNICUS (A)

```{r}
#| include: true
dfp_flow_all
```

*Example calculation:* The last row for retrospective is obtained by using the proportion left from BPC after filtering (59/542) and multiplying by the number of main GENIE cases (3651).  (59/542)*3651 ~ = 397.

## Definitions and decisions

The request for information we received had several criteria.  The following bullets state we defined each one in the context of the GENIE.

- **EGFR L858R or exon 19 inframe del (ever)** - Using the mutation data submitted to genie (MAF level), flag patients with either `HGVSp_Short = p.L858R` or with an exon 19 mutation with `Consequence` indicating an inframe deletion on EGFR.
- **Advanced or metastatic NSCLC** Participants were flagged as being in an advanced or metastatic state when either one of the following events occurred:
  - Diagnosed with Stage III or IV cancer NSCLC.
  - Metastasis location recorded anytime after diagnosis (mostly by imaging).
- **Line of therapy** A regimen used after reaching the advanced or metastatic state.  We filter out consecutive repeats.  For example, a patient with 1L GemCarbo cannot have a 2L GemCarbo.  The 1L is the first regimen used in that state, 2L is second, etc.
- **Baseline ECOG value of 0/1** Sites submit both ECOG and Karnofsky scores.  We convert any Karnofsky scores to ECOG (https://oncologypro.esmo.org/oncology-in-practice/practice-tools/performance-scales) and take the most recent score before the indexing event.  If a participant has no scores before the index event then they do not meet the criterion.
- **Disease Recurrence** To have a recurrence we're looking for a series of three events:
  1. Diagnosis of advanced/metastatic disease.
  2. After that, at least one radiology or medical oncology note showing "No evidence of cancer".
  3. After that, at least one radiology or medical oncology note showing evidence of cancer.

The most precise/accurate definition for all the steps (especially which variables are used) can be always be found in the code (https://github.com/Sage-Bionetworks/genie-project-requests/tree/main/2024-04-30_wu_egfr_nsclc).
  


